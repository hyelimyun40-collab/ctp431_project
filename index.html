<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interactive Piano Video Instrument</title>

<style>
body {
  margin: 0;
  background: #111;
  color: #eee;
  font-family: system-ui, -apple-system, sans-serif;
}

.wrap {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ---------- VIDEO ---------- */
.stage {
  width: min(900px, 92vw);
  aspect-ratio: 16 / 9;
  border-radius: 16px;
  overflow: hidden;
  position: relative;
  background: #000;
  margin-top: 40px;
}

.bg {
  position: absolute;
  inset: 0;
  background: url("assets/window.jpg") center / cover;
  display: grid;
  place-items: center;
  transition: opacity .15s ease;
}

.bg h1 {
  background: rgba(0,0,0,.45);
  padding: 18px 26px;
  border-radius: 14px;
  margin: 0;
}

video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  opacity: 0;
  transition: opacity .12s ease;
  pointer-events: none;
}

.playing video { opacity: 1; }
.playing .bg { opacity: 0; }

/* ---------- PIANO ---------- */
.keyboard {
  position: relative;
  width: 720px;
  height: 220px;
  margin-top: 40px;
}

.key {
  position: absolute;
  border: 1px solid #222;
  cursor: pointer;
  user-select: none;
}

.key.white {
  width: 60px;
  height: 220px;
  background: #fafafa;
  z-index: 1;
}
.key.white.active { background: #ddd; }

.key.black {
  width: 40px;
  height: 140px;
  background: #111;
  z-index: 2;
}
.key.black.active { background: #444; }

/* 키 라벨 */
.key-label {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 13px;
  font-weight: 700;
  opacity: .7;
  pointer-events: none;
}

.key.white .key-label { color: #333; }
.key.black .key-label {
  color: #eee;
  font-size: 11px;
  bottom: 12px;
}

/* ---------- FX ---------- */
.fx {
  display: flex;
  gap: 14px;
  margin-top: 30px;
}

.fx-btn {
  width: 72px;
  height: 72px;
  border-radius: 14px;
  background: #222;
  border: 1px solid #333;
  display: grid;
  place-items: center;
  font-weight: 700;
  cursor: pointer;
}
.fx-btn.active { background: #555; }

/* ---------- TEXT ---------- */
.description {
  margin-top: 40px;
  text-align: center;
}

.links {
  margin-top: 14px;
  display: flex;
  gap: 18px;
  justify-content: center;
}

.links a {
  color: #aaa;
  text-decoration: none;
  font-size: 14px;
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid #333;
}

.links a:hover {
  color: #fff;
  border-color: #666;
  background: rgba(255,255,255,.06);
}

/* 크레딧 */
.credit {
  margin-top: 26px;
  font-size: 13px;
  opacity: .55;
}
</style>
</head>

<body>
<div class="wrap">

  <div id="stage" class="stage">
    <div class="bg">
      <h1>Press keyboard key to play music</h1>
    </div>
    <video id="vid" playsinline preload="auto"></video>
  </div>

  <div id="keyboard" class="keyboard"></div>
  <div id="fx" class="fx"></div>

  <div class="description">
    <h2>Interactive Piano Video Instrument</h2>

    <div class="links">
      <a href="features.html">Features</a>
      <a href="howto.html">How to Use</a>
    </div>

    <div class="credit">
      by Hyerim Yun, Sangeun Cho (feat. 승헌쓰)
    </div>
  </div>

</div>

<script>
  /* =======================
     ADSR
  ======================= */
  const ADSR = {
    attack: 0.03,
    decay: 0.08,
    sustain: 0.7,
    release: 0.18
  };
  
  /* =======================
     AUDIO CONTEXT
  ======================= */
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const ctx = new AudioCtx();
  
  /* =======================
     ALL KEYS
  ======================= */
  const ITEMS = [
    {note:"C4",key:"KeyA",label:"A",type:"white",audio:"assets/승헌쓰_1(C4).wav",video:"assets/승헌쓰_1(C4).mp4"},
    {note:"C#4",key:"KeyW",label:"W",type:"black",audio:"assets/승헌쓰_2(C4s).wav",video:"assets/승헌쓰_2(C4s).mp4"},
    {note:"D4",key:"KeyS",label:"S",type:"white",audio:"assets/승헌쓰_3(D4).wav",video:"assets/승헌쓰_3(D4).mp4"},
    {note:"D#4",key:"KeyE",label:"E",type:"black",audio:"assets/승헌쓰_4(D4s).wav",video:"assets/승헌쓰_4(D4s).mp4"},
    {note:"E4",key:"KeyD",label:"D",type:"white",audio:"assets/승헌쓰_5(E4).wav",video:"assets/승헌쓰_5(E4).mp4"},
    {note:"F4",key:"KeyF",label:"F",type:"white",audio:"assets/승헌쓰_6(F4).wav",video:"assets/승헌쓰_6(F4).mp4"},
    {note:"F#4",key:"KeyT",label:"T",type:"black",audio:"assets/승헌쓰_7(F4s).wav",video:"assets/승헌쓰_7(F4s).mp4"},
    {note:"G4",key:"KeyG",label:"G",type:"white",audio:"assets/승헌쓰_8(G4).wav",video:"assets/승헌쓰_8(G4).mp4"},
    {note:"G#4",key:"KeyY",label:"Y",type:"black",audio:"assets/승헌쓰_9(G4s).wav",video:"assets/승헌쓰_9(G4s).mp4"},
    {note:"A4",key:"KeyH",label:"H",type:"white",audio:"assets/승헌쓰_10(A4).wav",video:"assets/승헌쓰_10(A4).mp4"},
    {note:"A#4",key:"KeyU",label:"U",type:"black",audio:"assets/승헌쓰_11(A4s).wav",video:"assets/승헌쓰_11(A4s).mp4"},
    {note:"B4",key:"KeyJ",label:"J",type:"white",audio:"assets/승헌쓰_12(B4).wav",video:"assets/승헌쓰_12(B4).mp4"},
    {note:"C5",key:"KeyK",label:"K",type:"white",audio:"assets/승헌쓰_13(C5).wav",video:"assets/승헌쓰_13(C5).mp4"},
    {note:"C#5",key:"KeyO",label:"O",type:"black",audio:"assets/승헌쓰_14(C5s).wav",video:"assets/승헌쓰_14(C5s).mp4"},
    {note:"D5",key:"KeyL",label:"L",type:"white",audio:"assets/승헌쓰_15(D5).wav",video:"assets/승헌쓰_15(D5).mp4"},
    {note:"D#5",key:"KeyP",label:"P",type:"black",audio:"assets/승헌쓰_16(D5s).wav",video:"assets/승헌쓰_16(D5s).mp4"},
    {note:"E5",key:"Semicolon",label:":",type:"white",audio:"assets/승헌쓰_17(E5).wav",video:"assets/승헌쓰_17(E5).mp4"},
    {note:"F5",key:"Quote",label:'"',type:"white",audio:"assets/승헌쓰_18(F5).wav",video:"assets/승헌쓰_18(F5).mp4"},
  
    {key:"KeyZ", label:"Z", fx:true, audio:"assets/shs_tonight.mp3", video:"assets/shs_tonight.mp4"},
    {key:"KeyX", label:"X", fx:true, audio:"assets/shs_2234.mp3",   video:"assets/shs_2234.mp4"},
    {key:"KeyC", label:"C", fx:true, audio:"assets/shs_huh.mp3",    video:"assets/shs_huh.mp4"},
    {key:"KeyV", label:"V", fx:true, audio:"assets/shs_yes.mp3",    video:"assets/shs_yes.mp4"},
    {key:"KeyB", label:"B", fx:true, audio:"assets/shs_wow.mp3",    video:"assets/shs_wow.mp4"},
    {key:"KeyN", label:"N", fx:true, audio:"assets/shs_clap.mp3",   video:"assets/shs_clap.mp4"},
    {key:"KeyM", label:"M", fx:true, audio:"assets/shs_thanks.mp3", video:"assets/shs_thanks.mp4"},
  ];
  
  const vid = document.getElementById("vid");
  const stage = document.getElementById("stage");
  vid.muted = true;
  
  /* =======================
     AUDIO SETUP (with Gain)
  ======================= */
  const audios = new Map();
  const gains  = new Map();
  const byKey  = new Map();
  let activeKeys = 0;
  
  const keyboard = document.getElementById("keyboard");
  const fxBox = document.getElementById("fx");
  let whiteIndex = 0;
  
  for (const item of ITEMS) {
    const audio = new Audio(item.audio);
    audio.loop = false;
  
    const source = ctx.createMediaElementSource(audio);
    const gain = ctx.createGain();
    gain.gain.value = 0;
  
    source.connect(gain).connect(ctx.destination);
  
    audios.set(item.key, audio);
    gains.set(item.key, gain);
  
    let el;
    if (item.fx) {
      el = document.createElement("div");
      el.className = "fx-btn";
      el.textContent = item.label;
      fxBox.appendChild(el);
    } else {
      el = document.createElement("div");
      el.className = `key ${item.type}`;
      el.style.left =
        item.type === "white"
          ? `${whiteIndex++ * 60}px`
          : `${whiteIndex * 60 - 20}px`;
  
      const label = document.createElement("div");
      label.className = "key-label";
      label.textContent = item.label;
      el.appendChild(label);
      keyboard.appendChild(el);
    }
  
    byKey.set(item.key, { data:item, el });
  }
  
  /* =======================
     PLAY / STOP with ADSR
  ======================= */
  function play(obj, el) {
    const audio = audios.get(obj.key);
    const gain  = gains.get(obj.key);
    const now = ctx.currentTime;
  
    if (audio.paused) {
      audio.currentTime = 0;
      audio.play().catch(()=>{});
      activeKeys++;
    }
  
    gain.gain.cancelScheduledValues(now);
    gain.gain.setValueAtTime(0, now);
    gain.gain.linearRampToValueAtTime(1, now + ADSR.attack);
    gain.gain.linearRampToValueAtTime(
      ADSR.sustain,
      now + ADSR.attack + ADSR.decay
    );
  
    stage.classList.add("playing");
    if (vid.src !== obj.video) {
      vid.src = obj.video;
      vid.load();
    }
    vid.currentTime = 0.001;
    vid.play().catch(()=>{});
  
    el.classList.add("active");
  }
  
  function stop(obj, el) {
    const audio = audios.get(obj.key);
    const gain  = gains.get(obj.key);
    const now = ctx.currentTime;
  
    gain.gain.cancelScheduledValues(now);
    gain.gain.setValueAtTime(gain.gain.value, now);
    gain.gain.linearRampToValueAtTime(0, now + ADSR.release);
  
    setTimeout(() => {
      audio.pause();
      audio.currentTime = 0;
    }, ADSR.release * 1000);
  
    activeKeys = Math.max(0, activeKeys - 1);
    if (activeKeys === 0) {
      vid.pause();
      vid.currentTime = 0;
      stage.classList.remove("playing");
    }
  
    el.classList.remove("active");
  }
  
  /* =======================
     AUDIO UNLOCK
  ======================= */
  function unlockAudio() {
    if (ctx.state !== "running") ctx.resume();
  }
  window.addEventListener("pointerdown", unlockAudio, { once:true });
  window.addEventListener("keydown", unlockAudio, { once:true });
  
  /* =======================
     KEY EVENTS
  ======================= */
  window.addEventListener("keydown", e => {
    if (e.repeat) return;
    const item = byKey.get(e.code);
    if (item) play(item.data, item.el);
  });
  
  window.addEventListener("keyup", e => {
    const item = byKey.get(e.code);
    if (item) stop(item.data, item.el);
  });
  </script>
  
</body>
</html>
